<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LaLa Land: o mundo Ã© o seu caderno</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50; --secondary-color: #3498db; --background-color: #ecf0f1;
            --border-color: #bdc3c7; --danger-color: #e74c3c;
            --warning-color: #f1c40f; --success-color: #27ae60; --theme-color: #c71585;
        }
        body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; background-color: var(--background-color); color: #333; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }
        
        .header { display: flex; align-items: center; justify-content: center; text-align: center; padding: 15px 0; background: linear-gradient(45deg, #d63384, var(--theme-color)); color: white; box-shadow: 0 4px 15px rgba(199, 21, 133, 0.2); position: relative; z-index: 1001; }
        .menu-btn { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; padding: 10px; border-radius: 50%; transition: background-color 0.2s; z-index: 2601; }
        .menu-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header h1 { margin: 0; font-size: 2.2rem; font-family: 'Playfair Display', serif; }
        
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
        .overlay.open-nav { z-index: 2500; display: block; }
        .overlay.open-tools { z-index: 1500; display: block; }

        .nav-drawer { position: fixed; top: 0; left: 0; width: 300px; height: 100%; background-color: #fff; z-index: 2600; box-shadow: 5px 0 20px rgba(0,0,0,0.2); transform: translateX(-100%); transition: transform 0.3s ease; padding-top: 80px; }
        .nav-drawer.open { transform: translateX(0); }
        .nav-drawer ul { list-style: none; padding: 0; margin: 0; }
        .nav-drawer li a { display: flex; align-items: center; gap: 15px; padding: 20px 25px; color: var(--primary-color); text-decoration: none; font-size: 1.2rem; font-weight: 500; transition: background-color 0.2s; border-left: 5px solid transparent; }
        .nav-drawer li a:hover { background-color: #f0f3f4; }
        .nav-drawer li a.active { background-color: var(--theme-color); color: white; border-left-color: #a6116d; font-weight: bold; }
        .nav-drawer li a i { width: 25px; text-align: center; }

        #caderno-view, #biblioteca-view { height: calc(100vh - 78px); }
        .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }

        #biblioteca-view { padding: 2rem; overflow-y: auto; }
        #biblioteca-view .biblioteca-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        #biblioteca-view h2 { margin: 0; color: var(--primary-color); }
        .biblioteca-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .aula-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 1.5rem; display: flex; flex-direction: column; justify-content: space-between; }
        .aula-card h4 { margin-top: 0; margin-bottom: 1rem; color: var(--primary-color); font-size: 1.2rem; }
        .aula-card-actions { display: flex; gap: 10px; margin-top: 1rem; }
        .aula-card-actions .btn { flex-grow: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .aula-card-actions .btn-load { background-color: var(--success-color); color: white; }
        .aula-card-actions .btn-load:hover { background-color: #229954; }
        .aula-card-actions .btn-delete { background-color: var(--danger-color); color: white; }
        .aula-card-actions .btn-delete:hover { background-color: #c0392b; }
        
        .map-wrapper { flex: 1; position: relative; overflow: hidden; min-height: 300px; height: 100%; }
        #map { height: 100%; width: 100%; background-color: #add8e6; }
        
        .sidebar { width: 350px; background-color: var(--background-color); padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 1002; }
        .sidebar-aula-title { background-color: var(--primary-color); color: white; padding: 15px; margin: -1rem -1rem 1rem -1rem; font-size: 1.1rem; text-align: center; font-weight: 500; }
        .sidebar-section { background-color: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 1rem 1.5rem; margin-bottom: 1.5rem; }
        .sidebar-section h3 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
        .tool-group { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 1px solid var(--background-color); }
        .tool-group:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .tool { background-color: #f0f0f0; border: 2px solid transparent; border-radius: 8px; width: 45px; height: 45px; cursor: pointer; font-size: 1.4rem; color: var(--primary-color); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .tool:hover { background-color: #e0e0e0; }
        .tool.active { background-color: var(--secondary-color); color: white; border-color: #2980b9; }
        #clear-button { background-color: var(--danger-color); color: white; }
        #undo-button { background-color: var(--warning-color); color: white; }
        #save-aula-button { width: 100%; padding: 12px; font-size: 1rem; font-weight: bold; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #save-aula-button:hover { background: #229954; }
        input[type="color"] { -webkit-appearance: none; width: 45px; height: 45px; border: none; cursor: pointer; padding: 0; background: none; border-radius: 8px; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid var(--border-color); border-radius: 8px; }
        .slider-container { display: flex; align-items: center; gap: 0.5rem; width: 100%; transition: opacity 0.3s ease; }
        .slider-container.disabled { opacity: 0.5; pointer-events: none; }
        .slider-container span { font-weight: bold; min-width: 40px; text-align: center; }
        input[type="range"] { flex-grow: 1; cursor: pointer; }
        .favorites-palette { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-top: 0.5rem; }
        .fav-swatch { width: 35px; height: 35px; border-radius: 50%; border: 3px solid transparent; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; }
        #new-aula-btn-lib { padding: 12px; font-size: 1rem; font-weight: bold; background: var(--secondary-color); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        #new-aula-btn-lib:hover { background: #2980b9; }
        .map-type-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 0.5rem; }
        .map-type-btn { background-color: #f0f0f0; border: 2px solid transparent; border-radius: 8px; padding: 10px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; font-weight: 500; color: var(--primary-color); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .map-type-btn:hover { background-color: #e0e0e0; border-color: #ccc; }
        .map-type-btn.selected { background-color: var(--theme-color); color: white; border-color: #a6116d; font-weight: bold; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 12px; width: 350px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); text-align: center; }
        .modal-input { width: 100%; box-sizing: border-box; padding: 10px; margin: 1rem 0; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem; }
        .modal-button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .modal-button.confirm { background-color: var(--success-color); color: white; }
        .modal-button.cancel { background-color: #ccc; color: #333; }
        
        .leaflet-container.drawing-enabled { cursor: crosshair !important; }
        canvas.leaflet-canvas-layer { pointer-events: auto; }
        
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 4000; display: flex; flex-direction: column; align-items: flex-end; }
        .notification-toast { display: flex; align-items: center; gap: 15px; color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: 500; min-width: 250px; animation: slideInRight 0.4s ease-out forwards; }
        .notification-toast.fade-out { animation: fadeOut 0.5s ease-in forwards; }
        .notification-toast.success { background-color: var(--success-color); }
        .notification-toast.error { background-color: var(--danger-color); }
        .notification-toast i { font-size: 1.5rem; }
        @keyframes slideInRight { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.9); } }

        .mobile-fab { display: none; }
        .custom-scrollbar { display: none; }

        body:not(.touch-device) .custom-scrollbar {
            display: block; position: absolute; background: rgba(0, 0, 0, 0.2); border-radius: 7px; opacity: 0;
            transition: opacity 0.3s ease-in-out; z-index: 1000;
        }
        body:not(.touch-device) .map-wrapper:hover .custom-scrollbar { opacity: 1; }
        body:not(.touch-device) .custom-scrollbar .thumb { background: rgba(0, 0, 0, 0.5); border-radius: 7px; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; position: absolute; }
        body:not(.touch-device) .custom-scrollbar .thumb:hover { background: rgba(0, 0, 0, 0.7); }
        body:not(.touch-device) .custom-scrollbar.horizontal { bottom: 0; left: 0; width: 100%; height: 14px; }
        body:not(.touch-device) .custom-scrollbar.horizontal .thumb { height: 100%; top: 0; }
        body:not(.touch-device) .custom-scrollbar.vertical { top: 0; right: 0; width: 14px; height: 100%; }
        body:not(.touch-device) .custom-scrollbar.vertical .thumb { width: 100%; left: 0; }
        
        body.touch-device .mobile-fab { 
            display: flex; position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; 
            background-color: var(--primary-color); color: white; border: none; border-radius: 50%; 
            font-size: 1.4rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; 
            z-index: 1001; align-items: center; justify-content: center; 
        }
        body.touch-device .sidebar {
            position: fixed; top: 0; left: 0; height: 100%;
            z-index: 2000; transform: translateX(-100%);
            -webkit-overflow-scrolling: touch;
            transition: transform 0.3s ease;
        }
        body.touch-device .sidebar.open { transform: translateX(0); }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .menu-btn { font-size: 1.5rem; }
            #biblioteca-view { padding: 1.5rem 1rem; }
            #biblioteca-view h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="header"><!-- ConteÃºdo do Header Completo --></div>
    <div class="overlay" id="overlay"></div>
    <nav class="nav-drawer" id="nav-drawer"><!-- ConteÃºdo do Menu Completo --></nav>
    <div id="caderno-view" style="display: none;"><!-- ConteÃºdo do Caderno Completo --></div>
    <div id="biblioteca-view"><!-- ConteÃºdo da Biblioteca Completo --></div>
    <div class="modal" id="new-aula-modal"><!-- ConteÃºdo do Modal Completo --></div>
    <div class="modal" id="pin-modal"><!-- ConteÃºdo do Modal Completo --></div>
    <div id="notification-container"></div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const ui = {
            menuBtn: document.getElementById('menu-btn'), navDrawer: document.getElementById('nav-drawer'), overlay: document.getElementById('overlay'),
            navLinks: document.querySelectorAll('.nav-link'), cadernoView: document.getElementById('caderno-view'),
            bibliotecaView: document.getElementById('biblioteca-view'), bibliotecaGrid: document.getElementById('biblioteca-grid'),
            newAulaBtnLib: document.getElementById('new-aula-btn-lib'), mobileToolsBtn: document.getElementById('mobile-tools-btn'),
            mapContainer: document.getElementById('map'), sidebar: document.querySelector('.sidebar'), activeAulaTitle: document.getElementById('active-aula-title'),
            newAulaModal: document.getElementById('new-aula-modal'), pinModal: document.getElementById('pin-modal'), brushToolBtn: document.getElementById('brush-tool'),
            eraserToolBtn: document.getElementById('eraser-tool'), pinToolBtn: document.getElementById('pin-tool'), undoBtn: document.getElementById('undo-button'),
            clearBtn: document.getElementById('clear-button'), saveAulaBtn: document.getElementById('save-aula-button'), sizeSlider: document.getElementById('brush-size'),
            sizeLabel: document.getElementById('brush-size-label'), opacitySlider: document.getElementById('opacity-slider'), opacityLabel: document.getElementById('opacity-label'),
            opacityContainer: document.getElementById('opacity-container'), colorPicker: document.getElementById('color-picker'), favoritesPalette: document.getElementById('favorites-palette'),
            hScroll: document.querySelector('.custom-scrollbar.horizontal'), vScroll: document.querySelector('.custom-scrollbar.vertical'),
            hThumb: document.querySelector('.custom-scrollbar.horizontal .thumb'), vThumb: document.querySelector('.custom-scrollbar.vertical .thumb'),
        };
        let state = {
            isDrawing: false, currentTool: 'brush', brushSize: 5, color: '#e74c3c', opacity: 1.0,
            favoriteColors: ["#e74c3c", "#2ecc71", "#3498db", "#f1c40f", "#9b59b6", "#34495e", "#ffffff", "#000000"],
            aulas: [], activeAulaId: null, currentStroke: null, isRedrawQueued: false, isDraggingThumb: false,
            currentInteractionMode: 'draw', editingPin: null, currentView: 'biblioteca'
        };
        
        let mapInitialized = false;
        let map = null;
        let mapLayers = {};
        let currentMapLayer = 'political';
        let canvasOverlay = null;

        const showNotification = (message, type = 'success', duration = 3000) => { const container = document.getElementById('notification-container'); const toast = document.createElement('div'); toast.className = `notification-toast ${type}`; const icons = { success: 'fa-check-circle', error: 'fa-times-circle' }; toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`; container.appendChild(toast); setTimeout(() => { toast.classList.add('fade-out'); toast.addEventListener('animationend', () => toast.remove()); }, duration); };
        
        const initializeMap = () => {
            if (mapInitialized) { return; }

            map = L.map(ui.mapContainer, { center: [20, 0], zoom: 3, minZoom: 2, worldCopyJump: true, maxBounds: [[-90, -180], [90, 180]], maxBoundsViscosity: 1.0, zoomControl: false, dragging: true, touchZoom: true, scrollWheelZoom: true });
            L.control.zoom({ position: 'topright' }).addTo(map);
            
            mapLayers = { political: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }), physical: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenTopoMap' }), satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Â© Esri' }), night: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© CARTO' }) };
            mapLayers[currentMapLayer].addTo(map);

            const CanvasOverlay = L.Layer.extend({
                onAdd: function(map) { this._map = map; this._canvas = L.DomUtil.create('canvas', 'leaflet-canvas-layer'); map.getPanes().overlayPane.appendChild(this._canvas); this._update(); map.on('moveend resize', this._update, this); this._canvas.addEventListener('mousedown', this._onDrawStart.bind(this)); this._canvas.addEventListener('mousemove', this._onDrawing.bind(this)); window.addEventListener('mouseup', this._onDrawEnd.bind(this)); this._canvas.addEventListener('touchstart', this._onDrawStart.bind(this), { passive: false }); this._canvas.addEventListener('touchmove', this._onDrawing.bind(this), { passive: false }); window.addEventListener('touchend', this._onDrawEnd.bind(this)); },
                onRemove: function(map) { map.getPanes().overlayPane.removeChild(this._canvas); map.off('moveend resize', this._update, this); },
                _update: function() { const size = this._map.getSize(); this._canvas.width = size.x; this._canvas.height = size.y; const topLeft = this._map.containerPointToLayerPoint([0, 0]); L.DomUtil.setPosition(this._canvas, topLeft); this.redraw(); },
                redraw: function() { const ctx = this._canvas.getContext('2d'); ctx.clearRect(0, 0, this._canvas.width, this._canvas.height); if (!state.activeAulaId) return; const aula = state.aulas.find(a => a.id === state.activeAulaId); if (!aula) return; aula.drawings.forEach(stroke => this._drawStroke(stroke, ctx)); if (state.isDrawing && state.currentStroke) this._drawStroke(state.currentStroke, ctx); },
                _drawStroke: function(stroke, ctx) { if (!stroke || stroke.points.length < 1) return; ctx.globalCompositeOperation = stroke.tool === 'eraser' ? 'destination-out' : 'source-over'; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = stroke.size; ctx.strokeStyle = stroke.color; ctx.globalAlpha = stroke.opacity; const points = stroke.points.map(latlng => this._map.latLngToContainerPoint(latlng)); if (points.length < 2) { ctx.beginPath(); ctx.fillStyle = ctx.strokeStyle; ctx.arc(points[0].x, points[0].y, stroke.size/2, 0, 2*Math.PI); ctx.fill(); return; } ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); for (let i = 1; i < points.length - 2; i++) { const c = (points[i].x + points[i+1].x) / 2; const d = (points[i].y + points[i+1].y) / 2; ctx.quadraticCurveTo(points[i].x, points[i].y, c, d); } ctx.quadraticCurveTo(points[points.length-2].x, points[points.length-2].y, points[points.length-1].x, points[points.length-1].y); ctx.stroke(); ctx.globalCompositeOperation = 'source-over'; },
                _onDrawStart: function(e) { if (map && !map.dragging.enabled()) { e.stopPropagation(); e.preventDefault(); state.isDrawing = true; state.currentStroke = { tool: state.currentTool, color: state.currentTool === 'eraser' ? 'rgba(0,0,0,1)' : state.color, size: state.brushSize, opacity: state.currentTool === 'eraser' ? 1.0 : state.opacity, points: [this._map.mouseEventToLatLng(e.touches ? e.touches[0] : e)] }; } },
                _onDrawing: function(e) { if(state.isDrawing) { e.preventDefault(); state.currentStroke.points.push(this._map.mouseEventToLatLng(e.touches ? e.touches[0] : e)); queueRedraw(); } },
                _onDrawEnd: function() { if (state.isDrawing) { if (state.currentStroke?.points.length > 1) { const a = state.aulas.find(a => a.id === state.activeAulaId); if (a) a.drawings.push(state.currentStroke); } state.currentStroke = null; queueRedraw(); } state.isDrawing = false; }
            });
            canvasOverlay = new CanvasOverlay().addTo(map);
            map.on('moveend zoomend', updateScrollbars);
            mapInitialized = true;
        };

        const queueRedraw = () => { if (!state.isRedrawQueued) { state.isRedrawQueued = true; requestAnimationFrame(() => { if (canvasOverlay) canvasOverlay.redraw(); state.isRedrawQueued = false; }); } };
        
        const toggleNavDrawer = () => { ui.navDrawer.classList.toggle('open'); ui.overlay.classList.toggle('open-nav'); ui.sidebar.classList.remove('open'); ui.overlay.classList.remove('open-tools'); };
        const toggleToolsSidebar = () => { ui.sidebar.classList.toggle('open'); ui.overlay.classList.toggle('open-tools'); };
        
        const switchView = (viewName) => {
            state.currentView = viewName;
            const isCaderno = viewName === 'caderno';
            ui.cadernoView.style.display = isCaderno ? 'block' : 'none';
            ui.bibliotecaView.style.display = isCaderno ? 'none' : 'block';
            
            ui.navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewName));
            
            if (isCaderno) { 
                if (!mapInitialized) { initializeMap(); }
                else { setTimeout(() => map.invalidateSize(), 100); }
                if (!state.activeAulaId) { ui.activeAulaTitle.textContent = "Nenhuma aula carregada"; }
            } else { state.activeAulaId = null; renderBiblioteca(); }

            if(ui.navDrawer.classList.contains('open')) { toggleNavDrawer(); }
        };

        const renderBiblioteca = () => { ui.bibliotecaGrid.innerHTML = ''; if (state.aulas.length === 0) { ui.bibliotecaGrid.innerHTML = '<p>Nenhuma aula encontrada. Crie uma para comeÃ§ar!</p>'; return; } state.aulas.forEach(aula => { const card = document.createElement('div'); card.className = 'aula-card'; card.innerHTML = `<h4>${aula.name}</h4><div class="aula-card-actions"><button class="btn btn-load" data-id="${aula.id}"><i class="fas fa-edit"></i> Carregar</button><button class="btn btn-delete" data-id="${aula.id}"><i class="fas fa-trash"></i> Excluir</button></div>`; ui.bibliotecaGrid.appendChild(card); }); };
        const loadAulasFromStorage = () => { try { const s = localStorage.getItem('geoCadernoAulas'); state.aulas = s ? JSON.parse(s) : []; } catch (e) { console.error("Failed to load aulas:", e); state.aulas = []; } };
        const saveAulasToStorage = () => localStorage.setItem('geoCadernoAulas', JSON.stringify(state.aulas));
        const openNewAulaModal = () => { const d = `Aula de ${new Date().toLocaleDateString('pt-BR')}`; document.getElementById('aula-name-input').value = d; ui.newAulaModal.style.display = 'flex'; document.getElementById('aula-name-input').select(); };
        const createNewAula = (name) => { const newAula = { id: Date.now(), name: name, mapType: currentMapLayer, drawings: [], pins: [] }; state.aulas.unshift(newAula); saveAulasToStorage(); ui.newAulaModal.style.display = 'none'; showNotification('Nova aula criada!'); loadAula(newAula.id); };
        const loadAula = (id) => { initializeMap(); const a = state.aulas.find(a => a.id === id); if (!a) return; state.activeAulaId = id; ui.activeAulaTitle.textContent = a.name; updateActiveTool(state.currentTool); switchMap(a.mapType); queueRedraw(); loadPinsForCurrentAula(); switchView('caderno'); };
        const deleteAula = (id) => { if (!confirm("Tem certeza que deseja excluir esta aula?")) return; state.aulas = state.aulas.filter(a => a.id !== id); if (state.activeAulaId === id) { state.activeAulaId = null; } saveAulasToStorage(); renderBiblioteca(); showNotification('Aula excluÃ­da.', 'error'); };
        
        const openPinModalForNew = (latlng) => { state.editingPin = { id: Date.now(), latlng, title: '', description: '', images: [], links: [], color: '#e74c3c' }; document.getElementById('pin-modal-title').innerText = 'Adicionar Novo Pin'; document.getElementById('delete-pin-btn').style.display = 'none'; clearPinModal(); ui.pinModal.style.display = 'flex'; };
        const openPinModalForEdit = (pin) => { state.editingPin = JSON.parse(JSON.stringify(pin)); document.getElementById('pin-modal-title').innerText = 'Editar Pin'; document.getElementById('delete-pin-btn').style.display = 'block'; clearPinModal(); document.getElementById('pin-title').value = state.editingPin.title; document.getElementById('pin-description').value = state.editingPin.description; document.getElementById('pin-color-input').value = state.editingPin.color; renderPinImagesPreview(); renderPinLinksPreview(); ui.pinModal.style.display = 'flex'; };
        const clearPinModal = () => { document.getElementById('pin-title').value = ''; document.getElementById('pin-description').value = ''; document.getElementById('pin-images-preview').innerHTML = ''; document.getElementById('pin-links-container').innerHTML = ''; document.getElementById('pin-color-input').value = '#e74c3c'; };
        const handleImageFiles = (files) => { for (const file of files) { if (!file.type.startsWith('image/')) continue; const reader = new FileReader(); reader.onload = (e) => { state.editingPin.images.push(e.target.result); renderPinImagesPreview(); }; reader.readAsDataURL(file); } };
        const renderPinImagesPreview = () => { const c = document.getElementById('pin-images-preview'); c.innerHTML = ''; state.editingPin.images.forEach((src, i) => { const w = document.createElement('div'); w.className = 'img-wrapper'; w.innerHTML = `<img src="${src}" alt="Preview" style="width: 80px; height: 80px; border-radius: 5px; object-fit: cover;"><button class="remove-img-btn" data-index="${i}" style="position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; line-height: 1;">Ã</button>`; c.appendChild(w); }); };
        const addLinkFromInput = () => { const input = document.getElementById('link-url-input'); let url = input.value.trim(); if (!url) return; const type = getYouTubeId(url) ? 'youtube' : 'general'; state.editingPin.links.push({ type, url }); renderPinLinksPreview(); input.value = ''; };
        const renderPinLinksPreview = () => { const c = document.getElementById('pin-links-container'); c.innerHTML = ''; state.editingPin.links.forEach((link, i) => { const item = document.createElement('div'); item.className = 'link-item'; const icon = link.type === 'youtube' ? 'fab fa-youtube' : 'fas fa-link'; item.innerHTML = `<span><i class="${icon}"></i> ${link.url}</span><button class="remove-link-btn" data-index="${i}" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.2rem;">Ã</button>`; c.appendChild(item); }); };
        const getYouTubeId = (url) => { const re = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = url.match(re); return (match && match[2].length === 11) ? match[2] : null; };
        const savePin = () => { const title = document.getElementById('pin-title').value.trim(); if (!title) { showNotification("O tÃ­tulo Ã© obrigatÃ³rio.", "error"); return; } state.editingPin.title = title; state.editingPin.description = document.getElementById('pin-description').value.trim(); state.editingPin.color = document.getElementById('pin-color-input').value; const aula = state.aulas.find(a => a.id === state.activeAulaId); if (!aula) return; if (!aula.pins) aula.pins = []; const pinIndex = aula.pins.findIndex(p => p.id === state.editingPin.id); if (pinIndex > -1) { aula.pins[pinIndex] = state.editingPin; } else { aula.pins.push(state.editingPin); } loadPinsForCurrentAula(); ui.pinModal.style.display = 'none'; state.editingPin = null; };
        const deleteCurrentPin = () => { if (!state.editingPin || !confirm("Tem certeza que deseja excluir este pin?")) return; const aula = state.aulas.find(a => a.id === state.activeAulaId); if (!aula || !aula.pins) return; aula.pins = aula.pins.filter(p => p.id !== state.editingPin.id); loadPinsForCurrentAula(); ui.pinModal.style.display = 'none'; state.editingPin = null; };
        const clearAllMapPins = () => { if (!map) return; map.eachLayer(layer => { if (layer.options.isPin) map.removeLayer(layer); }); };
        const loadPinsForCurrentAula = () => { clearAllMapPins(); const a = state.aulas.find(a => a.id === state.activeAulaId); if (a?.pins) a.pins.forEach(addPinToMap); };
        const addPinToMap = (pinData) => { const icon = L.divIcon({ className: 'custom-pin-icon', html: `<i class="fas fa-map-marker-alt" style="font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); line-height: 1; color: ${pinData.color || '#e74c3c'};"></i><span style="position: absolute; top: 8px; left: 0; right: 0; font-size: 1rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; pointer-events: none;">${pinData.title.charAt(0).toUpperCase()}</span>` }); const marker = L.marker(pinData.latlng, { icon, isPin: true, pinId: pinData.id }).addTo(map); let content = `<div class="pin-popup-content"><h4>${pinData.title}</h4>`; if (pinData.description) content += `<p>${pinData.description.replace(/\n/g, '<br>')}</p>`; if (pinData.images?.length > 0) { content += '<div class="images-container">'; pinData.images.forEach(img => content += `<img src="${img}" style="max-width: 100%; border-radius: 5px; margin-top: 5px;">`); content += '</div>'; } if (pinData.links?.length > 0) { content += '<div class="links-container">'; pinData.links.forEach(link => { if (link.type === 'youtube') { content += `<div class="youtube-embed" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin: 10px 0;"><iframe src="https://www.youtube.com/embed/${getYouTubeId(link.url)}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0" allowfullscreen></iframe></div>`; } else { content += `<a href="${link.url}" target="_blank" style="display: block; margin: 5px 0; color: var(--secondary-color); word-break: break-all;">${link.url}</a>`; } }); content += '</div>'; } marker.bindPopup(content); marker.on('dblclick', () => openPinModalForEdit(pinData)); };
        const clearAll = () => { if (!confirm("Isso limparÃ¡ TODOS os desenhos e pins desta aula. Deseja continuar?")) return; if (state.activeAulaId) { const a = state.aulas.find(a => a.id === state.activeAulaId); if (a) { a.drawings = []; a.pins = []; } queueRedraw(); loadPinsForCurrentAula(); }};
        const undoLast = () => { if (!state.activeAulaId) return; const a = state.aulas.find(a => a.id === state.activeAulaId); if (a?.drawings?.length > 0) { a.drawings.pop(); queueRedraw(); } };
        const switchMap = (mapType) => { if (mapLayers[mapType] && mapType !== currentMapLayer) { map.removeLayer(mapLayers[currentMapLayer]); currentMapLayer = mapType; map.addLayer(mapLayers[currentMapLayer]); if(state.activeAulaId) { const a = state.aulas.find(a => a.id === state.activeAulaId); if(a) a.mapType = mapType; } } document.querySelectorAll('.map-type-btn').forEach(b => b.classList.toggle('selected', b.dataset.map === mapType)); };
        const selectColor = (color) => { state.color = color; ui.colorPicker.value = color; document.querySelectorAll('.fav-swatch').forEach(s => s.style.borderColor = s.style.backgroundColor === color ? 'var(--primary-color)' : 'transparent'); updateActiveTool('brush'); };
        
        const updateActiveTool = (tool) => {
            const isPin = tool === 'pin'; const isEraser = tool === 'eraser';
            const isDrawingTool = tool === 'brush' || tool === 'eraser';
            
            state.currentInteractionMode = isPin ? 'pin' : 'draw';
            if (!isPin) state.currentTool = tool;
            
            ui.opacityContainer.classList.toggle('disabled', isEraser);
            ui.brushToolBtn.classList.toggle('active', tool === 'brush');
            ui.eraserToolBtn.classList.toggle('active', isEraser);
            ui.pinToolBtn.classList.toggle('active', isPin);
            
            if (mapInitialized) {
                if (isDrawingTool) { map.dragging.disable(); ui.mapContainer.classList.add('drawing-enabled'); } 
                else { map.dragging.enable(); ui.mapContainer.classList.remove('drawing-enabled'); }

                if(isPin) { map.once('click', (e) => { if(state.currentInteractionMode === 'pin') openPinModalForNew(e.latlng); }); }
            }
        };
        
        const initializeApp = () => {
            if (isTouchDevice) document.body.classList.add('touch-device');
            loadAulasFromStorage();
            
            ui.menuBtn.addEventListener('click', toggleNavDrawer);
            ui.overlay.addEventListener('click', () => { ui.navDrawer.classList.remove('open'); ui.sidebar.classList.remove('open'); ui.overlay.classList.remove('open-nav', 'open-tools'); });
            ui.navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); switchView(e.currentTarget.dataset.view); }); });
            ui.mobileToolsBtn.addEventListener('click', toggleToolsSidebar);

            ui.newAulaBtnLib.addEventListener('click', openNewAulaModal);
            ui.bibliotecaGrid.addEventListener('click', (e) => { 
                e.preventDefault();
                const btn = e.target.closest('.btn');
                if (!btn) return;
                const id = Number(btn.dataset.id);
                if (btn.classList.contains('btn-load')) {
                    loadAula(id);
                } else if (btn.classList.contains('btn-delete')) {
                    deleteAula(id);
                }
            });
            
            document.getElementById('confirm-new-aula').addEventListener('click', () => { const n = document.getElementById('aula-name-input').value.trim(); if (n) createNewAula(n); else showNotification("Por favor, insira um nome.", "error"); });
            document.getElementById('cancel-new-aula').addEventListener('click', () => ui.newAulaModal.style.display = 'none');
            ui.newAulaModal.addEventListener('click', (e) => { if(e.target === ui.newAulaModal) ui.newAulaModal.style.display = 'none'; });
            ui.brushToolBtn.addEventListener('click', () => updateActiveTool('brush'));
            ui.eraserToolBtn.addEventListener('click', () => updateActiveTool('eraser'));
            ui.pinToolBtn.addEventListener('click', () => updateActiveTool('pin'));
            ui.undoBtn.addEventListener('click', undoLast); ui.clearBtn.addEventListener('click', clearAll);
            ui.saveAulaBtn.addEventListener('click', () => { saveAulasToStorage(); showNotification('ModificaÃ§Ãµes salvas!'); });
            ui.sizeSlider.addEventListener('input', e => { state.brushSize = e.target.value; ui.sizeLabel.textContent = e.target.value; });
            ui.opacitySlider.addEventListener('input', e => { state.opacity = e.target.value / 100; ui.opacityLabel.textContent = `${e.target.value}%`; });
            ui.colorPicker.addEventListener('input', e => selectColor(e.target.value));
            document.querySelectorAll('.map-type-btn').forEach(b => b.addEventListener('click', () => switchMap(b.dataset.map)));
            ui.pinModal.addEventListener('click', (e) => { if (e.target.closest('.remove-img-btn')) { state.editingPin.images.splice(e.target.closest('.remove-img-btn').dataset.index, 1); renderPinImagesPreview(); } if (e.target.closest('.remove-link-btn')) { state.editingPin.links.splice(e.target.closest('.remove-link-btn').dataset.index, 1); renderPinLinksPreview(); } });
            document.getElementById('save-pin').addEventListener('click', savePin); document.getElementById('delete-pin-btn').addEventListener('click', deleteCurrentPin); document.getElementById('cancel-pin').addEventListener('click', () => { ui.pinModal.style.display = 'none'; });
            document.getElementById('add-link-btn').addEventListener('click', addLinkFromInput);
            const dropzone = document.getElementById('pin-image-dropzone'); dropzone.addEventListener('click', () => document.getElementById('image-upload').click()); dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.backgroundColor = '#f0f0f0'; }); dropzone.addEventListener('dragleave', () => { dropzone.style.backgroundColor = 'transparent'; }); dropzone.addEventListener('drop', (e) => { e.preventDefault(); dropzone.style.backgroundColor = 'transparent'; if(e.dataTransfer.files.length > 0) handleImageFiles(e.dataTransfer.files); });
            document.getElementById('image-upload').addEventListener('change', (e) => handleImageFiles(e.target.files));
            window.addEventListener('paste', (e) => { if (ui.pinModal.style.display === 'flex') handleImageFiles(e.clipboardData.files); });
            const renderFavorites = () => { ui.favoritesPalette.innerHTML = ''; state.favoriteColors.forEach(c => { const s = document.createElement('div'); s.className = 'fav-swatch'; s.style.backgroundColor = c; s.addEventListener('click', () => selectColor(c)); ui.favoritesPalette.appendChild(s); }); };
            const setupScrollbarDrag=(t,s,i)=>{t.addEventListener("pointerdown",e=>{e.stopPropagation();let o=o=>{let n=0,d=0;const a=map.getPixelWorldBounds().max.x-map.getPixelWorldBounds().min.x,r=map.getPixelWorldBounds().max.y-map.getPixelWorldBounds().min.y,l=map.getSize();i?(n=o.movementX*a/l.x):(d=o.movementY*r/l.y),map.panBy([n,d],{animate:!1})};const n=()=>{window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",n)};window.addEventListener("pointermove",o),window.addEventListener("pointerup",n)})};const updateScrollbars=()=>{if(isTouchDevice || !mapInitialized)return;const t=map.getSize(),s=map.getPixelWorldBounds(),e=map.getPixelBounds();if(!s||!e||!t||t.x===0||t.y===0)return;const o=s.max.x-s.min.x,n=s.max.y-s.min.y,d=e.max.x-e.min.x,a=e.max.y-e.min.y;if(o<=0||n<=0)return;const r=d/o*t.x,l=a/n*t.y,c=(e.min.x-s.min.x)/o*t.x,h=(e.min.y-s.min.y)/n*t.y;ui.hThumb.style.width=`${Math.max(r,15)}px`,ui.vThumb.style.height=`${Math.max(l,15)}px`,ui.hThumb.style.left=`${c}px`,ui.vThumb.style.top=`${h}px`};
            if (!isTouchDevice) { setupScrollbarDrag(ui.hThumb, ui.hScroll, true); setupScrollbarDrag(ui.vThumb, ui.vScroll, false); }
            
            window.addEventListener('resize', () => { if (state.currentView === 'caderno' && mapInitialized) { setTimeout(() => map.invalidateSize(), 100); } });

            renderBiblioteca(); renderFavorites();
            switchView('biblioteca'); 
            setTimeout(() => { if (!isTouchDevice) updateScrollbars() }, 500);
        };
        initializeApp();
    });
    </script>
</body>
</html>
